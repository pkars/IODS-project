# Analysis of longitudinal data
Hoo boy. It's the last week of IODS course, and this time we're analyzing data
that includes non-independent measurements (e.g. repeated measurements of
a test subject over time). Let's start with the libraries and data exploration!
```{r ch6-setup, message=FALSE}
# Setup block
# Remove the '##' from each line of R output blocks
knitr::opts_chunk$set(comment = '')

# Libraries
library(dplyr)
library(ggplot2)
```

This week's assignment has a twist! We are going to repeat the examples from 
Vehkalahti and Everitt (2019) book *Multivariate Analysis for The Behavioral Sciences*, 
chapters 8 and 9, except with the data sets swapped between the chapters. I've 
wrangled the data to a "long table" format in the corresponding wrangling exercise.
You can find the code [here](https://github.com/pkars/IODS-project/blob/master/data/meet_and_repeat.R).

So first we have the `rats` data introduced in Ch. 9. The authors describe the data as following:

*[W]e shall use some data from a nutrition study conducted in three groups of rats (Crowder and Hand, 1990). The three groups were put on different diets, and each animalâ€™s body weight (grams) was recorded repeatedly (approximately weekly, except in week seven when two recordings were taken) over a 9-week period. The question of most interest is whether the growth profiles of the three groups differ.*

```{r c6-data-rats}
rats <- read.csv("data/rats.csv")
rats$ID <- as.factor(rats$ID)
rats$Group <- as.factor(rats$Group)
str(rats)
summary(rats)
```

Next, we have the `bprs`data introduced in Ch. 8. The authors' description follows:

*Table 8.1 taken from Davis (2002). Here 40 male subjects were randomly assigned to one of two treatment groups and each subject was rated on the brief psychiatric rating scale (BPRS) measured before treatment began (week 0) and then at weekly intervals for eight weeks. The BPRS assesses the level of 18 symptom constructs such as hostility, suspiciousness, hallucinations and grandiosity; each of these is rated from one (not present) to seven (extremely severe). The scale is used to evaluate patients suspected of having schizophrenia.*

```{r c6-data-bprs}
bprs <- read.csv("data/bprs.csv")
bprs$treatment <- as.factor(bprs$treatment)
bprs$subject <- as.factor(bprs$subject)
str(bprs)
summary(bprs)
```

## Working with RATS data
First plot the rats weight values (Fig. 8.1)

```{r}
ggplot(rats, aes(x = time, y = weight, linetype= ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, 2)) +
  facet_grid(. ~ Group, labeller=label_both) +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(min(rats$weight), max(rats$weight)))

```

Standardize (Fig 8.2)

```{r}
rats_tracked <- rats %>% 
  group_by(time) %>%
  mutate(std.weight = (weight - mean(weight))/sd(weight)) %>%
  ungroup()

ggplot(rats_tracked, aes(x = time, y = std.weight, linetype= ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, 2)) +
  facet_grid(. ~ Group, labeller=label_both) +
  theme(legend.position = "none") +
  scale_y_continuous("Standardized weight")

```

Mean response profiles (Fig. 8.3)
```{r eval=F}
# Number of weeks, baseline (week 0) included
#n <- BPRSL$week %>% unique() %>% length()
n <- rats$time %>% unique() %>% length()

# Summary data with mean and standard error of bprs by treatment and week 
BPRSS <- rats %>%
  group_by(treatment, week) %>%
  summarise( mean = mean(bprs), se = sd(bprs)/sqrt(n) ) %>%
  ungroup()

# Glimpse the data
glimpse(BPRSS)

# Plot the mean profiles
ggplot(BPRSS, aes(x = week, y = mean, linetype = treatment, shape = treatment)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.8)) +
  scale_y_continuous(name = "mean(bprs) +/- se(bprs)")
```

Boxplots for rats data (Fig. 8.4)
```{r}
ggplot(rats, aes(x=as.factor(time), y=weight, color=Group)) +
  geom_boxplot()
```

Boxplots of mean summary measures for the three rat groups (Fig. 8.5), outliers (if any) removed (Fig. 8.6)
```{r}
# Create a summary data by treatment and subject with mean as the summary variable (ignoring baseline day 1).
rats_sm <- rats %>%
  filter(time > 1) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(weight) ) %>%
  ungroup()

# Glimpse the data
glimpse(rats_sm)

# Draw a boxplot of the mean versus treatment
ggplot(rats_sm, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight), time > 1")
```
Group 2 has an outlier. Remove it.
```{r}
# Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
rats_sm1 <-  rats_sm %>% filter(mean < 575)
glimpse(rats_sm1)

ggplot(rats_sm1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight), time > 1")
```

t-test Mean Summary Measure (table 8.3)
```{r}
rats_sm1_noG3 <- rats_sm1 %>% filter(Group != 3)
t.test(mean ~ Group, data = rats_sm1_noG3, var.equal = TRUE)

rats_sm1_noG2 <- rats_sm1 %>% filter(Group != 2)
t.test(mean ~ Group, data = rats_sm1_noG2, var.equal = TRUE)

rats_sm1_noG1 <- rats_sm1 %>% filter(Group != 1)
t.test(mean ~ Group, data = rats_sm1_noG1, var.equal = TRUE)
```

Analysis of Covariance (ANOVA) (table 8.4)
```{r}
original_rats <- read.csv("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt",
                          header=TRUE, sep="\t")
rats_sm2 <- rats_sm %>%
  mutate(baseline = original_rats$WD1)

fit <- lm(mean ~ baseline + Group, data = rats_sm2)
anova(fit)
```

(Results - Independent Samples t-test for Mean Summary Measure for data with missing values, table 8.6, - omitted as it uses data not seen here)

## Working with BPRS data

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```


# Analysis of longitudinal data
Hoo boy. It's the last week of IODS course, and this time we're analyzing data
that includes non-independent measurements (e.g. repeated measurements of
a test subject over time). Let's start with the libraries and data exploration!
```{r ch6-setup, message=FALSE}
# Setup block
# Remove the '##' from each line of R output blocks
knitr::opts_chunk$set(comment = '')

# Libraries
library(dplyr)
library(ggplot2)
library(stringr)
library(lme4)
```

This week's assignment has a twist! We are going to repeat the examples from 
Vehkalahti and Everitt (2019) book *Multivariate Analysis for The Behavioral Sciences*, 
chapters 8 and 9, except with the data sets swapped between the chapters. I've 
wrangled the data to a "long table" format in the corresponding wrangling exercise.
You can find the code [here](https://github.com/pkars/IODS-project/blob/master/data/meet_and_repeat.R).

So first we have the `rats` data introduced in Ch. 9. The authors describe the data as following:

*[W]e shall use some data from a nutrition study conducted in three groups of rats (Crowder and Hand, 1990). The three groups were put on different diets, and each animal’s body weight (grams) was recorded repeatedly (approximately weekly, except in week seven when two recordings were taken) over a 9-week period. The question of most interest is whether the growth profiles of the three groups differ.*

```{r c6-data-rats}
rats <- read.csv("data/rats.csv")
rats$ID <- as.factor(rats$ID)
rats$Group <- as.factor(rats$Group)
str(rats)
summary(rats)
```

Next, we have the `bprs`data introduced in Ch. 8. The authors' description follows:

*Table 8.1 taken from Davis (2002). Here 40 male subjects were randomly assigned to one of two treatment groups and each subject was rated on the brief psychiatric rating scale (BPRS) measured before treatment began (week 0) and then at weekly intervals for eight weeks. The BPRS assesses the level of 18 symptom constructs such as hostility, suspiciousness, hallucinations and grandiosity; each of these is rated from one (not present) to seven (extremely severe). The scale is used to evaluate patients suspected of having schizophrenia.*

```{r c6-data-bprs}
bprs <- read.csv("data/bprs.csv")
bprs$treatment <- as.factor(bprs$treatment)
bprs$subject <- as.factor(bprs$subject)
str(bprs)
summary(bprs)
```

## Working with RATS data
First plot the rats weight values (Fig. 8.1)

```{r}
ggplot(rats, aes(x = time, y = weight, linetype= ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, 2)) +
  facet_grid(. ~ Group, labeller=label_both) +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(min(rats$weight), max(rats$weight)))

```

Standardize (Fig 8.2)

```{r}
rats_tracked <- rats %>% 
  group_by(time) %>%
  mutate(std.weight = (weight - mean(weight))/sd(weight)) %>%
  ungroup()

ggplot(rats_tracked, aes(x = time, y = std.weight, linetype= ID)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:8, 2)) +
  facet_grid(. ~ Group, labeller=label_both) +
  theme(legend.position = "none") +
  scale_y_continuous("Standardized weight")

```

Mean response profiles (Fig. 8.3)
```{r eval=F}
# Number of weeks, baseline (week 0) included
#n <- BPRSL$week %>% unique() %>% length()
n <- rats$time %>% unique() %>% length()

# Summary data with mean and standard error of bprs by treatment and week 
ratss <- rats %>%
  group_by(Group, time) %>%
  summarise( mean = mean(weight), se = sd(weight)/sqrt(n) ) %>%
  ungroup()

# Glimpse the data
glimpse(ratss)

# Plot the mean profiles
ggplot(ratss, aes(x = time, y = mean, linetype = Group, shape = Group)) +
  geom_line() +
  scale_linetype_manual(values = c(1,2,3)) +
  geom_point(size=3) +
  scale_shape_manual(values = c(1,2,3)) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3) +
  theme(legend.position = c(0.8,0.5)) +
  scale_y_continuous(name = "mean(weight) +/- se(weight)")
```

Boxplots for rats data (Fig. 8.4)
```{r}
ggplot(rats, aes(x=as.factor(time), y=weight, color=Group)) +
  geom_boxplot()
```

Boxplots of mean summary measures for the three rat groups (Fig. 8.5), outliers (if any) removed (Fig. 8.6)
```{r}
# Create a summary data by treatment and subject with mean as the summary variable (ignoring baseline day 1).
rats_sm <- rats %>%
  filter(time > 1) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(weight) ) %>%
  ungroup()

# Glimpse the data
glimpse(rats_sm)

# Draw a boxplot of the mean versus treatment
ggplot(rats_sm, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight), time > 1")
```
Group 2 has an outlier. Remove it.
```{r}
# Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
rats_sm1 <-  rats_sm %>% filter(mean < 575)
glimpse(rats_sm1)

ggplot(rats_sm1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(weight), time > 1")
```

t-test Mean Summary Measure (table 8.3)
```{r}
rats_sm1_noG3 <- rats_sm1 %>% filter(Group != 3)
t.test(mean ~ Group, data = rats_sm1_noG3, var.equal = TRUE)

rats_sm1_noG2 <- rats_sm1 %>% filter(Group != 2)
t.test(mean ~ Group, data = rats_sm1_noG2, var.equal = TRUE)

rats_sm1_noG1 <- rats_sm1 %>% filter(Group != 1)
t.test(mean ~ Group, data = rats_sm1_noG1, var.equal = TRUE)
```

Analysis of Covariance (ANOVA) (table 8.4)
```{r}
original_rats <- read.csv("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt",
                          header=TRUE, sep="\t")
rats_sm2 <- rats_sm %>%
  mutate(baseline = original_rats$WD1)

fit <- lm(mean ~ baseline + Group, data = rats_sm2)
anova(fit)
```

(Results - Independent Samples t-test for Mean Summary Measure for data with missing values, table 8.6, - omitted as it uses data not seen here)

## Working with BPRS data
Week vs BPRS with group numbers (Fig. 9.1)
```{r}
ggplot(bprs, aes(x=week, y=bprs, color=treatment)) +
  #geom_point(aes(shape=treatment, color=treatment)) +
  geom_text(aes(label=treatment), show.legend=FALSE)
```

Results from fitting linear reg.model ignoring the repeated-measures structure of the data (Table 9.3)
```{r}
# create a regression model RATS_reg
bprs_reg <- lm(bprs ~ week + treatment, data = bprs)
# print out a summary of the model
summary(bprs_reg)
```

Individual BTRS profiles (Fig. 9.2)
```{r}
# Check the dimensions of the data
dim(bprs)

#bprs$key <- str.concatenate(as.character(bprs$treatment))
#str(bprs)

# Plot the RATSL data
ggplot(bprs, aes(x = week, y = bprs)) +
  geom_line(aes(linetype=treatment)) +
  scale_x_continuous(name = "Weight (grams)") +
  theme(legend.position = "top")
```

Scatterplot matrix of repeated measures (Fig. 9.3)
```{r}
```

Results from fitting random intercept model (Table 9.4)
```{r eval=F}
# Create a random intercept model
RATS_ref <- lmer(Weight ~ Time + Group + (1 | ID), data = RATSL, REML = FALSE)

# Print the summary of the model
summary(RATS_ref)

```

Results from fitting random intercept and slope model (Table 9.5)
```{r eval=F}
# dplyr, tidyr, lme4, ggplot2, RATS and RATSL are available

# create a random intercept and random slope model
RATS_ref1 <- lmer(Weight ~ Time + Group + (Time | ID), data = RATSL, REML = FALSE)

# print a summary of the model
summary(RATS_ref1)

# perform an ANOVA test on the two models
anova(RATS_ref1, RATS_ref)

```

Results from Fitting the Random Intercept and Slope Model that Allows for a Group×Time Interaction to Rat Growth Data (Table 9.6)
```{r eval=F}
# dplyr, tidyr, lme4, ggplot2, RATS and RATSL are available

# create a random intercept and random slope model with the interaction
RATS_ref2 <- lmer(Weight ~ Time + Group + Time * Group + (Time | ID), data = RATSL, REML = FALSE)

# print a summary of the model
summary(RATS_ref2)

# perform an ANOVA test on the two models
anova(RATS_ref2, RATS_ref1)

# draw the plot of RATSL with the observed Weight values
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Observed weight (grams)") +
  theme(legend.position = "top")

# Create a vector of the fitted values
Fitted <- fitted(RATS_ref2, RATSL)

# Create a new column fitted to RATSL
RATSL$Fitted <- Fitted

# draw the plot of RATSL with the Fitted values of weight
ggplot(RATSL, aes(x = Time, y = Fitted, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 20)) +
  scale_y_continuous(name = "Fitted weight (grams)") +
  theme(legend.position = "top")

```

Fitted and observed growth profiles (Figure 9.4)
```{r eval=F}

```



